
# Firebase Firestore Security Rules

This document outlines recommended Firestore security rules for the application.

```javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // === Users Collection ===
    // Stores public user profiles, club ownership, and athlete club affiliation.
    // Document ID is the Firebase Auth UID.
    match /users/{userId} {
      // Allow authenticated users to read their own profile.
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated users to create their own profile document.
      // Typically done once during signup by the application.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated users to update their own profile document.
      // Users can update their name, mobile, photoURL, club affiliation.
      // Club ownership fields (ownedClubId, ownedClubName, ownedClubLogoUrl, etc.)
      // are typically set by server actions (e.g., during club registration)
      // which use Admin SDK and bypass these rules.
      // This rule allows client-side updates for common profile fields.
      allow update: if request.auth != null && request.auth.uid == userId &&
                       // Allow updates to common fields by the user themselves
                       (request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['name', 'mobile', 'photoURL', 'clubId', 'clubAffiliationDate', 'clubName', 'updatedAt', 'ownedClubId', 'ownedClubName', 'ownedClubLogoUrl', 'ownedClubInstagramUrl', 'ownedClubFacebookUrl']));
                       // isAdmin should only be updatable by a trusted admin process, not by the user.

      // Disallow client-side deletion of user profiles by default.
      allow delete: if false; // Or only allow admin, or self-delete if required
    }

    // === OTP Attempts Collection (No longer used for client-side OTP login, functions use Admin SDK) ===
    match /otp_attempts/{email} {
      allow read, write, create, delete: if false; // Disallow all client access
    }

    // === Clubs Collection ===
    // Stores information about registered clubs.
    // Document ID is auto-generated by Firestore.
    match /clubs/{clubId} {
      // Allow any authenticated user to read club details
      // (e.g., for selection dropdowns by athletes or public leaderboards).
      allow read: if request.auth != null;

      // Club creation is handled by a server action (`registerClubWithOwner`)
      // which uses the Admin SDK and bypasses these client-side rules.
      // If direct client-side creation were allowed, it would need to ensure
      // `request.resource.data.ownerUid == request.auth.uid`.
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;


      // Allow the club owner (identified by `ownerUid` field in the club document)
      // to update their own club document.
      // Ensure ownerUid cannot be changed by the owner during an update.
      // Ensure other critical fields are validated if necessary.
      // Example: Allow owner to update name, coach_name, email, mobile, logoUrl, social links.
      allow update: if request.auth != null && resource.data.ownerUid == request.auth.uid
                      && request.resource.data.ownerUid == resource.data.ownerUid // ownerUid cannot be changed by this rule
                      && (request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['name', 'coach_name', 'email', 'mobile', 'logoUrl', 'instagramUrl', 'facebookUrl', 'updatedAt']));


      // Allow the club owner to delete their own club document.
      allow delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }

    // === Events Collection (New for Event Calendar) ===
    // Stores information about race events for the calendar.
    // Document ID is auto-generated by Firestore.
    match /events/{eventId} {
      // Allow any user (authenticated or not) to read event details for the calendar.
      allow read: if true;

      // Allow write (create, update, delete) only by an admin user.
      // This requires having an `isAdmin` custom claim or a field in the admin's user profile.
      // For this example, assuming an `isAdmin` field in the `/users/{request.auth.uid}` document.
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
```

**Explanation of Rules:**

*   **`/users/{userId}`:**
    *   Read, Create, Update: Users can manage their own profile data. Update rule allows changes to common fields including club ownership fields by the owner (typically managed via server actions which bypass client rules, but this provides flexibility if client-side updates for these are ever directly enabled and properly controlled). `isAdmin` is NOT included in client-updatable fields.
    *   Delete: Client-side deletion disallowed.
*   **`/otp_attempts/{email}`:**
    *   All client access is disallowed. Firebase Functions use Admin SDK.
*   **`/clubs/{clubId}`:**
    *   Read: Authenticated users can read club data.
    *   Create: Club owner can create (primarily via server action).
    *   Update: Only the club owner can update their club's details (name, coach, contact, logo, social links). `ownerUid` cannot be changed by this rule.
    *   Delete: Only the club owner can delete their club.
*   **`/events/{eventId}` (New):**
    *   Read: Publicly readable for displaying the event calendar.
    *   Write (Create, Update, Delete): Only allowed if the requesting authenticated user has an `isAdmin == true` field in their `/users/{userId}` document. This is a common way to implement admin-only write access. You could also use Firebase Auth custom claims for `isAdmin`.

**Important Considerations:**
*   **Admin SDK Usage:** Server Actions (like `registerClubWithOwner`, `updateUserProfile`, `addCalendarEventAction`) and Firebase Functions using the Firebase Admin SDK **bypass** these client-side Firestore security rules. This is intended for trusted server-side operations.
*   **Testing:** Always test your security rules thoroughly using the Firebase Emulator Suite or the Rules Playground in the Firebase Console.
*   **`isAdmin` Flag:** For the `/events` write rule to work, you need a mechanism to set `isAdmin: true` on the Firestore `users` document for your administrator accounts. This is typically done manually in Firestore or via a secure admin function.

This set of rules provides a good balance of security and functionality for your application.
